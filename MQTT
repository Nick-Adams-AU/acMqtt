--[[
Event-based, execute during ramping, name: "MQTT"

Pushes CBus events to MQTT resident scripts via internal sockets. Used with Home Assistant.

Tag required objects with the "MQTT" keyword and this script will run whenever one of those objects change.

It seems that this script must be disabled/enabled to enable it to be tied to new objects assigned the MQTT
keyword, and the MQTT send/receive script does this automatically every time a change is detected.
--]]

logging = false
server = require('socket').udp()

sKey = 'pre'..event.dst
toSet = true
val = event.getvalue()
pre = -1
comp = val

parts = string.split(event.dst, '/')
app = tonumber(parts[2])

if app ~= 202 then -- Not trigger app
  pre = storage.get(sKey)
  if tonumber(val) then comp = string.format('%.3f', val) end
  if comp == pre then
    toSet = false
    if logging and not toSet then log('Not setting '..event.dst..' to '..comp..', previous value is '..pre) end
  end
else
  toSet = false -- Don't send trigger control. One-way from MQTT to CBus...
end

if toSet then
  if logging then log('Setting '..event.dst..' to '..comp..', previous='..pre) end

  server:sendto(event.dst.."/"..val, '127.0.0.1', 5432) -- Send an event to publish to broker
end
